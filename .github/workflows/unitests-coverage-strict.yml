name: Unit Test Coverage (Strict)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit-coverage-strict:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Run unit tests with coverage
        run: dotnet test ./Atlas.Api.Tests/Atlas.Api.Tests.csproj --configuration Release --collect:"XPlat Code Coverage" --settings ./coverage.runsettings

      - name: Install ReportGenerator
        run: dotnet tool install --tool-path ./.tools dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: ./.tools/reportgenerator -reports:"Atlas.Api.Tests/TestResults/**/coverage.cobertura.xml" -targetdir:"artifacts/coverage-unit-strict" -reporttypes:"Html;TextSummary"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage-strict
          path: |
            Atlas.Api.Tests/TestResults/**/coverage.cobertura.xml
            artifacts/coverage-unit-strict/**

      - name: Enforce >=90% line coverage
        run: |
          python - <<'PY'
          import glob
          import sys
          import xml.etree.ElementTree as ET

          threshold = 0.90
          files = sorted(glob.glob('Atlas.Api.Tests/TestResults/**/coverage.cobertura.xml', recursive=True))
          if not files:
            print('FAIL: coverage.cobertura.xml was not generated.')
            sys.exit(1)

          latest = files[-1]
          root = ET.parse(latest).getroot()
          line_rate = float(root.attrib.get('line-rate', 0.0))

          if line_rate >= threshold:
            print(f'PASS: line coverage {line_rate:.2%} meets threshold {threshold:.0%}.')
            sys.exit(0)

          print(f'FAIL: line coverage {line_rate:.2%} is below threshold {threshold:.0%}.')
          sys.exit(1)
          PY
